# Q-Quest 量子神託：設計の流れ

## 全体像

ユーザー入力から「どのキャラが現れるべきか」を決定する流れを説明します。

## 4つのExcelファイルの役割

### 1. sense_to_vow_initial_filled_from_user.xlsx
**8感覚 → 12誓願の重み（感覚が誓願を引き寄せる）**

- **行**: 8つの感覚（迷い/焦り/静けさ/内省/行動/つながり/挑戦/待つ）
- **列**: 12誓願（誓願01～誓願12）
- **値**: 負の値 = その感覚がその誓願を引き寄せる、正の値 = 引き寄せない

**直感的な意味：**
- 迷いが強い → 誓願05/07/10が呼ばれやすい
- 静けさが強い → 誓願02/11が呼ばれやすい

### 2. akiba12_character_to_vow_K.xlsx
**12神 → 12誓願の重み（誓願がキャラを引き寄せる）**

- **行**: 12神（キャラクター）
- **列**: 12誓願（誓願01～誓願12）
- **値**: 負の値 = その誓願が選ばれやすい、正の値 = 選ばれにくい

**意味**: この誓願なら、この神が「語り手として自然」という関係を数値で持っている

### 3. akiba12_character_to_axis_L.xlsx
**12神 → 4軸の重み（キャラクターの性格ベクトル）**

- **行**: 12神（キャラクター）
- **列**: 4軸（静・流・間・誠）
- **値**: 負の値 = その世界観軸が強い、正の値 = 弱い

### 4. akiba12_character_list.xlsx
**12神の説明文・役割（UI表示用の辞書）**

12神の基本情報（ID、名前、属性、絵文字、説明、格言）を定義します。

## 処理の流れ

### ステップ1: ユーザー入力 → 感情スコア（Mood）

ユーザーが絵馬に文字を入力すると、その文章から感情スコア（Mood）を作成します。

**Moodの5つの要素：**
- 疲れ（fatigue）
- 不安/焦り（anxiety）
- 好奇心（curiosity）
- 孤独（loneliness）
- 決断力（decisiveness）

### ステップ2: Mood → 感覚ベクトル x（8次元）

Moodから感覚ベクトル x（8次元）を生成します。

**8つの感覚：**
- x0: 迷い
- x1: 焦り
- x2: 静けさ
- x3: 内省
- x4: 行動
- x5: つながり
- x6: 挑戦
- x7: 待つ

### ステップ3: x（感覚）→ v（誓願）を引き寄せる

**sense_to_vow行列を使用（中核データ）**

感覚ベクトル x（連続値0〜5）から、対応する誓願 v が選ばれやすくなります。

**QUBOの相互作用項：**
```
H_sense-vow = Σ_{i,j} W_{ij} x_i v_j
```

- **W_{ij}**: `sense_to_vow_matrix[i, j]` = 感覚iが誓願jを引き寄せる強さ
- **負の値（例：-0.4）**: 引き寄せ（相性が良い）→ エネルギーを下げる
- **正の値（例：+0.2）**: 離す（相性が悪い）→ エネルギーを上げる

**例：**
- 迷い（x0）が強い → 誓願05/07/10が呼ばれやすい（sense_to_vow行列の値による）
- 静けさ（x2）が強い → 誓願02/11が呼ばれやすい

**この行列の役割：**
- 「絵馬の文章 → 願いの方向（誓願）」を数理でつなぐ中核データ
- ユーザーの感覚スコア（0〜5）から「誓願」を自動推定できる
- 文章補助（キーワード抽出）と相性が良い

### ステップ4: v（誓願）→ c（キャラ）を引き寄せる

**k行列（character_to_vow_K）を使用**

選ばれた誓願 v に応じて、対応するキャラクター c が選ばれやすくなります。

**意味**: この誓願なら、この神が「語り手として自然」という関係を数値で持っている

### ステップ5: QUBOで最終決定

**QUBOでone-hot制約により、誓願1つ、キャラ1体が選ばれる**

- **誓願**: one-hot制約（12のうち1つ）
- **キャラ**: one-hot制約（12のうち1体）

**QUBOでやる意味：**

感覚（x）が揺れると、"近い候補が複数" 出る（＝低エネルギー帯）

これが **神託っぽさ（唯一解じゃない）** を作ります。

## QUBOの構造

### 変数の定義

- **x**: 0～7（感覚変数、8次元）
- **v**: 8～19（誓願変数、12次元）
- **c**: 20～31（キャラクター変数、12次元）

**合計**: 32次元のバイナリ変数

### QUBOの項

1. **H_sense**: 感覚エネルギー項
   - `H_sense = Σ_i a_i x_i`

2. **H_vow**: 誓願選択項（one-hot制約）
   - `H_vow = λ_v (Σ_j v_j - 1)^2`
   - 12のうち1つだけが選ばれる

3. **H_char**: キャラクター選択項（one-hot制約）
   - `H_char = λ_c (Σ_k c_k - 1)^2`
   - 12のうち1体だけが選ばれる

4. **H_interaction**: 相互作用項
   - **感覚 × 誓願**: `H_sense-vow = Σ_{i,j} W_{ij} x_i v_j`（sense_to_vow行列を使用）
     - `W_{ij}`: `sense_to_vow_matrix[i, j]` = 感覚iが誓願jを引き寄せる強さ
     - 負の値 = 引き寄せ（エネルギーを下げる）、正の値 = 離す（エネルギーを上げる）
   - **誓願 × キャラ**: `K_{jk} v_j c_k`（k行列を使用）
   - **感覚 × キャラ**: `L_{ik} x_i c_k`（l行列を使用）

## まとめ

1. **ユーザー入力** → Mood → 感覚ベクトル x（8次元）
2. **x（感覚）→ v（誓願）** を引き寄せる（sense_to_vow行列）
3. **v（誓願）→ c（キャラ）** を引き寄せる（k行列）
4. **QUBOで最終決定**（one-hot制約により、誓願1つ、キャラ1体が選ばれる）

この設計により、ユーザーの悩みに応じて、適切なキャラクターが現れ、神託を授けることができます。